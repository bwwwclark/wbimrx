<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>ICD-10 RAF Sorter</title>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
</head>
<body>
  <h1>ICD-10 RAF Sorter</h1>
  <textarea id="inputCodes" rows="10" cols="50" placeholder="Enter ICD-10 codes separated by commas or new lines..."></textarea>
  <br><br>
  <button onclick="sortCodes()">Sort by RAF Score</button>

  <h2>Sorted Codes:</h2>
  <ul id="output"></ul>

  <script>
    let icd10Data = {};

    // Fetch data from published Google Sheet CSV using PapaParse
    async function fetchData() {
      try {
        const url = "https://docs.google.com/spreadsheets/d/e/2PACX-1vThTqAjzi-MoiSxDNiKIEqcRVR0qiVwCLqmiQVR7CWo0e5tNfpVM8eOO7LOSsnstNOV_-4yXfFAdAVr/pub?output=csv";
        const response = await fetch(url);
        const csvText = await response.text();

        Papa.parse(csvText, {
          header: true,
          skipEmptyLines: true,
          complete: function(results) {
            results.data.forEach(row => {
              const code = row["Diagnosis Code"]?.replace(/['"\s]+/g, '').trim().toUpperCase();
              const score = parseFloat(row["CMS-HCC Model Score V28"]) || null;
              if (code) {
                icd10Data[code] = { score };
              }
            });
            console.log(`Loaded ${Object.keys(icd10Data).length} codes.`);
            console.log("Sample codes:", Object.keys(icd10Data).slice(0, 10));
          },
          error: function(error) {
            console.error("PapaParse error:", error);
          }
        });
      } catch (error) {
        console.error("Error fetching or parsing data:", error);
      }
    }

    async function sortCodes() {
      if (Object.keys(icd10Data).length === 0) {
        await fetchData();
      }

      const input = document.getElementById('inputCodes').value;

      // Split by commas or newlines, clean spaces and quotes
      const codes = input.split(/[\n,]/).map(code => code.replace(/['"\s]+/g, '').trim().toUpperCase()).filter(code => code !== "");

      console.log("User input:", codes);

      const codesWithScores = codes.map(code => {
        const info = icd10Data[code];
        return {
          code,
          score: info?.score ?? null
        };
      });

      // Sort descending, put 'null' (not found) at the bottom
      codesWithScores.sort((a, b) => {
        if (a.score === null) return 1;
        if (b.score === null) return -1;
        return b.score - a.score;
      });

      // Output
      const output = document.getElementById('output');
      output.innerHTML = '';
      codesWithScores.forEach(entry => {
        const li = document.createElement('li');
        if (entry.score === null) {
          li.textContent = `${entry.code} - Not Found`;
        } else {
          li.textContent = `${entry.code} - RAF Score: ${entry.score}`;
        }
        output.appendChild(li);
      });
    }

    // Preload data
    fetchData();
  </script>
</body>
</html>
